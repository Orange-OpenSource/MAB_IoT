#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include <float.h>
#include <string.h>
#include "type.h"


void dofg()
{
    int* sortedPlayers;
    sortedPlayers=(int*)malloc(sizeof(int)*N);

    sortedPlayers=sortPlayers();

    //for(int i=0;i<N;i++)
        //printf("%d(%d)____%f\n",sortedPlayers[i],i,Player[sortedPlayers[i]].p);

    float ** PI;
    int ** q;

    PI=(float **)malloc(sizeof(float *)*N);
	for (int i=0;i<N;i++) PI[i]=(float *)malloc(sizeof(float)*K);

    q=(int **)malloc(sizeof(int *)*N);
	for (int i=0;i<N;i++) q[i]=(int *)malloc(sizeof(int)*K);
	//initialization
	for (int k=0;k<K;k++)
    {
        PI[sortedPlayers[0]][k]=1.0;
    }
    printf("after alloc\n");
    //start
    for (int n=0;n<N;n++)
    {
        int maxK=0;
        for(int k=0;k<K;k++)
        {//printf("arm mean=%f, first value=%f second=%f\n",Arm[k],Arm[k]*PI[sortedPlayers[n]][k]*(1.0-L[sortedPlayers[n]][k]),Arm[maxK]*PI[sortedPlayers[n]][maxK]*(1.0-L[sortedPlayers[n]][maxK]));
            if(Algorithm==0)
            {if(Arm[k]*PI[sortedPlayers[n]][k]>=Arm[maxK]*PI[sortedPlayers[n]][maxK])
                //printf("yes\n");
                maxK=k;}
            else if(finalEstimation[k]*PI[sortedPlayers[n]][k]>=finalEstimation[maxK]*PI[sortedPlayers[n]][maxK])
                    maxK=k;
        }
        //printf("found maxK=%d for player %d\n",maxK,sortedPlayers[n]);
        for(int k=0;k<K;k++)
            {if(k==maxK)
                {q[sortedPlayers[n]][k]=1;
                Player[sortedPlayers[n]].armToPlay=k;
                if(n<N-1)
                    {PI[sortedPlayers[n+1]][k]=PI[sortedPlayers[n]][k]*(1-Player[sortedPlayers[n]].pr);
                    }
                }

            else
                {q[sortedPlayers[n]][k]=0;
                if(n<N-1)
                    {PI[sortedPlayers[n+1]][k]=PI[sortedPlayers[n]][k];
                    }
                }

            }

    }
    for(int k=0;k<K;k++)
    {
        float sum=0.0;
        for(int n=0;n<N;n++)
            if(Player[n].armToPlay==k)sum=sum+Player[n].pr;
        printf("arm[%d]-->%f\n", k,sum);
    }
    ///expected mean reward
    float mean=0.0;
    float mult;
    float sum;
    for(int k=0;k<K;k++)
    {
        sum=0.0;
        for(int n=0;n<N;n++)
            {mult=Player[n].pr*q[n][k];
             for(int n1=0;n1<N;n1++)
                if(n1!=n) mult=mult*(1-Player[n1].pr*q[n1][k]);
             sum=sum+mult;
            }
        if(Algorithm==0) mean=mean+Arm[k]*sum;
        else mean=mean+finalEstimation[k]*sum;
    }
    printf("expected mean with fair greedy is=%f\n", mean);

    for(int k=0;k<K;k++)
    {
        printf("players playing arm %d:****\n",k);
        for(int n=0;n<N;n++)
        {
            if(Player[sortedPlayers[n]].armToPlay==k)
                printf("%d(%d)-",sortedPlayers[n],n);
        }
        printf("\n\n");
    }
}


