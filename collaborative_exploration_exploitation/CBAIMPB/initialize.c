
#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include <string.h>
#include "type.h"




void Alloc()
// Alloue toutes les structures mémoires
{
	int i,j,S;


	// serveur
	Lambda=(int **)malloc(sizeof(int *)*N);
	for (i=0;i<N;i++) Lambda[i]=(int *)malloc(sizeof(int)*K);

	omiga=(int **)malloc(sizeof(int *)*N);
	for (i=0;i<N;i++) omiga[i]=(int *)malloc(sizeof(int)*K);

	nb_plays=(int*)malloc(sizeof(int)*K);
	global_mu=(float*)malloc(sizeof(float)*K);
	// Joueurs
	Player=(struct Player *)malloc(N*sizeof(struct Player));
	for (i=0;i<N;i++) Player[i].B=(struct Bandit *)malloc(K*sizeof(struct Bandit));
	for (i=0;i<N;i++) Player[i].A=(int *)malloc(K*sizeof(int));
	for (i=0;i<N;i++) Player[i].nonOptimals=(int *)malloc((K-M)*sizeof(int));
	for (i=0;i<N;i++) Player[i].selected=(int *)malloc((M)*sizeof(int));
	for (i=0;i<N;i++) Player[i].discarded=(int *)malloc((K-M)*sizeof(int));

	average_mu=(float **)malloc(sizeof(float *)*Draws);
	Rewards=(float *)malloc(sizeof(float )*Draws);
	collRate=(float **)malloc(sizeof(float *)*Draws);
	loss=(int *)malloc(sizeof(int )*Draws);
	muMin=(float *)malloc(sizeof(float )*Draws);
    muMax=(float *)malloc(sizeof(float )*Draws);
    playersMeans=(float **)malloc(sizeof(float *)*Draws);
    playersRewards=(float*)malloc(sizeof(float)*N);
    duration=(int *)malloc(sizeof(int )*Draws);

	for (i=0;i<Draws;i++) {
		average_mu[i]=(float *)malloc(sizeof(float)*(T/(T/TimeDisplay)+1));
		collRate[i]=(float *)malloc(sizeof(float)*(T/(T/TimeDisplay)+1));
		playersMeans[i]=(int *)malloc(sizeof(int)*(N));
		for (j=0;j<N;j++) {playersMeans[i][j]=0.0;}
	}


	for (i=0;i<Draws;i++) {
		Rewards[i]=0.0;
		loss[i]=0;
		duration[i]=0;
	}
	// Action
	Action=(int *)malloc(sizeof(int)*K);
	globalSelected=(int *)malloc(sizeof(int)*K);
	globalDiscarded=(int *)malloc(sizeof(int)*K);
	Arm=(float *)malloc(sizeof(float)*K);

	// Logs
	S=T/TimeDisplay;
	Logs=(float **)malloc(sizeof(float *)*Draws);
	for (i=0;i<Draws;i++) {
		Logs[i]=(float *)malloc(sizeof(float)*S);
		for (j=0;j<S;j++) Logs[i][j]=0.0;
	}
	SampleC=(int *)malloc(sizeof(int )*Draws);
	collisions=(int *)malloc(sizeof(int )*Draws);
    plays=(int *)malloc(sizeof(int )*Draws);
	for (i=0;i<Draws;i++) {
		SampleC[i]=0;
		collisions[i]=0;
		plays[i]=0;
	}

	// Tampon mu
	mu=(float *)malloc(sizeof(float)*K);
}


int InitNetwork (char *filename)
// initialize the problem settings from the file param.txt
{
	FILE *fic;
	int ok;

    //printf("in init network\n");
	fic=fopen(filename,"r");
	if (fic == NULL) return 0;

	ok=fscanf(fic, "Algorithm=%d\n",&Algorithm);
	if (ok != 1) return 0;

	ok=fscanf(fic, "K=%d\n",&K);
	if (ok != 1) return 0;

	ok=fscanf(fic, "M=%d\n",&M);
	if (ok != 1) return 0;

	ok=fscanf(fic, "T=%d\n",&T);
	if (ok != 1) return 0;

	ok=fscanf(fic, "TimeDisplay=%d\n",&TimeDisplay);
	if (ok != 1) return 0;

	ok=fscanf(fic, "delta=%f\n",&delta);
	if (ok != 1) return 0;

	ok=fscanf(fic, "epsilon=%f\n",&epsilon);
	if (ok != 1) return 0;

	ok=fscanf(fic, "verbose=%d\n",&verbose);
	if (ok != 1) return 0;

	ok=fscanf(fic, "Draws=%d\n",&Draws);
	if (ok != 1) return 0;

	ok=fscanf(fic, "N=%d\n",&N);
	if (ok != 1) return 0;

	ok=fscanf(fic, "p1=%f\n",&p1);
	if (ok != 1) return 0;

	ok=fscanf(fic, "pN=%f\n",&pN);
	if (ok != 1) return 0;

	ok=fscanf(fic, "col=%f\n",&col);
	if (ok != 1) return 0;

	ok=fscanf(fic,"eta=%lf\n",&eta);
	if (ok != 1) return 0;

	ok=fscanf(fic,"comm=%d\n",&comm);
	if (ok != 1) return 0;

	ok=fscanf(fic,"reset=%d\n",&reset);
	if (ok != 1) return 0;

	//printf("in init network\n");
	fclose(fic);

	// test if delta
	if (Algorithm == 11 && delta < pow(eta,(float)N)) {
		printf("delta=%f < %f\n",delta,pow(eta,(float)N));
	 	return 0;
	}

	if (verbose == 1) printf("Allocations\n");
	Alloc();
	GenerateProblem_001();

	return 1;
}

