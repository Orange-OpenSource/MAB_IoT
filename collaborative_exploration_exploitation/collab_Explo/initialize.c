

#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include <string.h>
#include "type.h"



/**memory allocation
*/
void Alloc()
{
	int i,j,S;


	// serveur
	activeRates=(float *)malloc(sizeof(float)*N);
    finalEstimation=(float *)malloc(sizeof(float)*K);
	estimations=(float **)malloc(sizeof(float *)*N);
	for (i=0;i<N;i++) estimations[i]=(float *)malloc(sizeof(float)*K);

	wEXP=(float **)malloc(sizeof(float *)*N);
	for (i=0;i<N;i++) wEXP[i]=(float *)malloc(sizeof(float)*K);

    pEXP=(float **)malloc(sizeof(float *)*N);
	for (i=0;i<N;i++) pEXP[i]=(float *)malloc(sizeof(float)*K);


    countt=0;
	coll=(int **)malloc(sizeof(int *)*N);
	for (i=0;i<N;i++) coll[i]=(int *)malloc(sizeof(int)*K);

	nb_plays=(int*)malloc(sizeof(int)*K);
	global_mu=(float*)malloc(sizeof(float)*K);
	// Joueurs
	Player=(struct Player *)malloc(N*sizeof(struct Player));
	for (i=0;i<N;i++) Player[i].B=(struct Bandit *)malloc(K*sizeof(struct Bandit));
	for (i=0;i<N;i++) Player[i].A=(int *)malloc(K*sizeof(int));
	for (i=0;i<N;i++) activeRates[i]=0.0;

	// Action
	Action=(int *)malloc(sizeof(int)*K);
	Arm=(float *)malloc(sizeof(float)*K);

	// Logs
	S=T/TimeDisplay;
	playersRewards=(float*)malloc(sizeof(float)*N);
    plPerArm=(float *)malloc(sizeof(float)*K);
    for(i=0;i<K;i++)
        plPerArm[i]=0.0;

    armsPlays=(int *)malloc(sizeof(int)*K);
    for(i=0;i<K;i++)
        armsPlays[i]=0;

	mu_pi=(float **)malloc(sizeof(float *)*Draws);
	average_mu=(float **)malloc(sizeof(float *)*Draws);
	collRate=(float **)malloc(sizeof(float *)*Draws);
	avg_arm=(float **)malloc(sizeof(float *)*Draws);
	col_arm=(float **)malloc(sizeof(float *)*Draws);
    los_arm=(float **)malloc(sizeof(float *)*Draws);
    D=(float *)malloc(sizeof(float )*Draws);
    D_k=(float **)malloc(sizeof(float *)*Draws);
    playsPerPL=(int **)malloc(sizeof(int *)*Draws);
    playersMeans=(float **)malloc(sizeof(float *)*Draws);
    fairness=(float **)malloc(sizeof(float *)*Draws);
    counter0=0;

    globalT=(int *)malloc(sizeof(int )*Draws);
    globalR=(float *)malloc(sizeof(float)*Draws);
    globalS=(int *)malloc(sizeof(int )*Draws);

	for (i=0;i<Draws;i++) {
        collRate[i]=(float *)malloc(sizeof(float)*(T/(T/TimeDisplay)+1));
        fairness[i]=(float *)malloc(sizeof(float)*(T/(T/TimeDisplay)+1));

		mu_pi[i]=(float *)malloc(sizeof(float)*(T/(T/TimeDisplay)+1));
		average_mu[i]=(float *)malloc(sizeof(float)*(T/(T/TimeDisplay)+1));
		avg_arm[i]=(float *)malloc(sizeof(float)*(K));
		col_arm[i]=(float *)malloc(sizeof(float)*(K));
		los_arm[i]=(float *)malloc(sizeof(float)*(K));
		D_k[i]=(float *)malloc(sizeof(float)*(K));
		playsPerPL[i]=(int *)malloc(sizeof(int)*(N));
		playersMeans[i]=(float *)malloc(sizeof(float)*(N));
		for (j=0;j<K;j++) {avg_arm[i][j]=0.0;col_arm[i][j]=0.0;los_arm[i][j]=0.0;D_k[i][j]=0.0;}
		for (j=0;j<N;j++) {playsPerPL[i][j]=0;playersMeans[i][j]=0.0;}
	}
	sampleComplexity=(int *)malloc(sizeof(int )*Draws);
	rateCost=(int *)malloc(sizeof(int )*Draws);
	estimationCost=(int *)malloc(sizeof(int )*Draws);
	duration=(int *)malloc(sizeof(int )*Draws);
	totalTime=(int *)malloc(sizeof(int )*Draws);
	collisions=(int *)malloc(sizeof(int )*Draws);
	totalCollisions=(int *)malloc(sizeof(int )*Draws);
    plays=(int *)malloc(sizeof(int )*Draws);
    samples=(int *)malloc(sizeof(int )*Draws);
    mistakes=(int *)malloc(sizeof(int )*Draws);
    totalCost=(int *)malloc(sizeof(int )*Draws);
    Rewards=(float *)malloc(sizeof(float )*Draws);
    muMin=(float *)malloc(sizeof(float )*Draws);
    muMax=(float *)malloc(sizeof(float )*Draws);
    Pmin=(float *)malloc(sizeof(float )*Draws);
    Pmax=(float *)malloc(sizeof(float )*Draws);
    loss=(int *)malloc(sizeof(int )*Draws);
    X=(double *)malloc(sizeof(double )*Draws);
	for (i=0;i<Draws;i++) {
		rateCost[i]=0;
		collisions[i]=0;
		totalCollisions[i]=0;
		globalT[i]=0;
		globalR[i]=0.0;
		globalS[i]=0;
		sampleComplexity[i]=0;
		estimationCost[i]=0;
		duration[i]=0;
		totalTime[i]=0;
		totalCost[i]=0;
		plays[i]=0;
		samples[i]=0;
		Rewards[i]=0.0;
		loss[i]=0;
		X[i]=0;
		D[i]=0.0;
	}
    Xmin=100.0;
    Xmax=-100.0;
	for(i=0;i<K;i++)
        for(j=0;j<N;j++)
            {coll[j][i]=0;
             wEXP[j][i]=1;
            }

	mu=(float *)malloc(sizeof(float)*K);
}



int InitNetwork (char *filename)
// initialize the problem settings from the file param.txt
{
	FILE *fic;
	int ok;

    //printf("in init network\n");
	fic=fopen(filename,"r");
	if (fic == NULL) return 0;

	ok=fscanf(fic, "Algorithm=%d\n",&Algorithm);
	if (ok != 1) return 0;

	ok=fscanf(fic, "K=%d\n",&K);
	if (ok != 1) return 0;

	ok=fscanf(fic, "T=%d\n",&T);
	if (ok != 1) return 0;

	ok=fscanf(fic, "TimeDisplay=%d\n",&TimeDisplay);
	if (ok != 1) return 0;

	ok=fscanf(fic, "delta=%f\n",&delta);
	if (ok != 1) return 0;

	ok=fscanf(fic, "epsilon=%f\n",&epsilon);
	if (ok != 1) return 0;

	ok=fscanf(fic, "verbose=%d\n",&verbose);
	if (ok != 1) return 0;

	ok=fscanf(fic, "Draws=%d\n",&Draws);
	if (ok != 1) return 0;

	ok=fscanf(fic, "N=%d\n",&N);
	if (ok != 1) return 0;

	ok=fscanf(fic, "p1=%f\n",&p1);
	if (ok != 1) return 0;

	ok=fscanf(fic, "pN=%f\n",&pN);
	if (ok != 1) return 0;

	ok=fscanf(fic, "col=%f\n",&col);
	if (ok != 1) return 0;

	ok=fscanf(fic, "exploit=%d\n",&exploit);
	if (ok != 1) return 0;

	fclose(fic);

	if (verbose == 1) printf("Allocations\n");
	Alloc();
	printf("after alloc\n");
	GenerateProblem_001();

	return 1;
}

