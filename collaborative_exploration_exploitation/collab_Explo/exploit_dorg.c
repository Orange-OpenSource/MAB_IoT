#include <stdlib.h>
#include <stdio.h>
#include <math.h>
#include <float.h>
#include <string.h>
#include "type.h"

void dorg()
{
    printf("running optimal greedy\n");
    int* sortedPlayers;
    sortedPlayers=(int*)malloc(sizeof(int)*N);

    sortedPlayers=sortPlayers();

    float ** PI;
    float ** L;
    int ** q;

    PI=(float **)malloc(sizeof(float *)*N);
	for (int i=0;i<N;i++) PI[i]=(float *)malloc(sizeof(float)*K);

	L=(float **)malloc(sizeof(float *)*N);
	for (int i=0;i<N;i++) L[i]=(float *)malloc(sizeof(float)*K);

	q=(int **)malloc(sizeof(int *)*N);
	for (int i=0;i<N;i++) q[i]=(int *)malloc(sizeof(int)*K);
	//initialization
	for (int k=0;k<K;k++)
    {
        PI[sortedPlayers[0]][k]=1.0;
        L[sortedPlayers[0]][k]=0.0;
    }
    printf("after alloc\n");
    //start
    for (int n=0;n<N;n++)
    {
        int maxK=0;
        for(int k=0;k<K;k++)
        {if(Algorithm==0 )
            {if( Arm[k]*PI[sortedPlayers[n]][k]*(1.0-L[sortedPlayers[n]][k])>=Arm[maxK]*PI[sortedPlayers[n]][maxK]*(1.0-L[sortedPlayers[n]][maxK]) )
                    maxK=k;}
            else
                if(finalEstimation[k]*PI[sortedPlayers[n]][k]*(1.0-L[sortedPlayers[n]][k])>=finalEstimation[maxK]*PI[sortedPlayers[n]][maxK]*(1.0-L[sortedPlayers[n]][maxK]))
                {
                maxK=k;}
        }

        for(int k=0;k<K;k++)
            {if(k==maxK)
                {q[sortedPlayers[n]][k]=1;
                Player[sortedPlayers[n]].armToPlay=k;
                if(n<N-1)
                    {PI[sortedPlayers[n+1]][k]=PI[sortedPlayers[n]][k]*(1-Player[sortedPlayers[n]].pr);
                    L[sortedPlayers[n+1]][k]=L[sortedPlayers[n]][k]+Player[sortedPlayers[n]].pr/(1-Player[sortedPlayers[n]].pr);
                    }
                }

            else
                {q[sortedPlayers[n]][k]=0;
                if(n<N-1)
                    {PI[sortedPlayers[n+1]][k]=PI[sortedPlayers[n]][k];
                    L[sortedPlayers[n+1]][k]=L[sortedPlayers[n]][k];
                    }
                }

            }

    }

    for(int k=0;k<K;k++)
    {
        float sum=0.0;
        for(int n=0;n<N;n++)
            if(Player[n].armToPlay==k)sum=sum+Player[n].pr;
        printf("arm[%d]-->%f\n", k,sum);
    }
    ///expected mean reward
    float mean=0.0;
    float mult;
    float sum;
    float sumPn=0.0;

    for(int k=0;k<K;k++)
    {
        sum=0.0;
        for(int n=0;n<N;n++)
            {mult=1.0; if(k==0)sumPn=sumPn+Player[n].pr;
             for(int n1=0;n1<N;n1++)
                {if(n1!=n) mult=mult*(1-Player[n1].pr*q[n1][k]);}

             sum=sum+Player[n].pr*q[n][k]*mult;

            }
        if(Algorithm==0) mean=mean+Arm[k]*sum;
        else mean=mean+finalEstimation[k]*sum;
    }
    //mean=mean/sumPn;
    printf("expected mean with optimal greedy is=%f\n", mean);

    for(int k=0;k<K;k++)
    {
        printf("players playing arm %d:****\n",k);
        for(int n=0;n<N;n++)
        {
            if(Player[sortedPlayers[n]].armToPlay==k)
                printf("%d----",sortedPlayers[n]);
        }
        printf("\n");
    }
}

